{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'css/nutrition.css' %}" />
    <title>Calories Counter</title>
    <style>
      .header {
        height: 60px;
        background-color: #a8a48c;
        padding: 0 20px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #a8a48c;
      }

      .today {
        background-color: #9b957e;
        color: white;
        border-radius: 50%;
        padding: 5px;
      }
      .selected-day {
        border: 2px solid #9b957e;
      }
      .meal-entry {
        background-color: #f5f5f5;
        padding: 5px;
        margin: 3px 0;
        border-radius: 3px;
        font-size: 14px;
      }
      .remaining-positive {
        color: green;
      }
      .remaining-negative {
        color: red;
      }
      .container {
        display: flex;
        flex-wrap: wrap;
        padding: 20px;
      }
      .calendar {
        flex: 1;
        min-width: 300px;
        margin-right: 20px;
      }
      .summary {
        flex: 0 0 300px;
      }
      .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
      }
      .calendar-header h2 {
        margin: 0;
        font-size: 1.2rem;
      }
      .calendar-header button {
        background: #538558;
        border: none;
        color: white;
        padding: 10px 15px;
        border-radius: 25px;
        margin-bottom: 15px;
        cursor: pointer;
        font-size: 1em;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #a8a48c;
      }
      th {
        background-color: #e0decc;;
      }
      .circle {
        background: #f8f9fa;
        border-radius: 50%;
        width: 200px;
        height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 0 auto 20px;
      }
      .big-text {
        font-size: 2rem;
        font-weight: bold;
      }
      .macros {
        margin-bottom: 15px;
      }
      .macros p {
        margin: 5px 0;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        width: 90%;
        max-width: 500px;
      }
      .modal-content h2 {
        margin-top: 0;
      }
      .modal-content label {
        display: block;
        margin-bottom: 5px;
      }
      .modal-content input,
      .modal-content select {
        width: 100%;
        padding: 8px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 3px;
      }
      .modal-content button {
        padding: 8px 15px;
        margin-right: 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      #save-meal {
        background-color: #28a745;
        color: white;
      }
      #close-modal {
        background-color: #6c757d;
        color: white;
      }
      .delete-meal {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        font-size: 1rem;
      }
    </style>
  </head>
  <body>
    {% include 'components/header.html' %}

    <div class="container">
      <div class="calendar">
        <div class="calendar-header">
          <button id="prev-day">&lt;</button>
          <h2 id="current-date"></h2>
          <button id="next-day">&gt;</button>
          <button id="add-meal">Add Meal</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>Meal Type</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="meals-list">
            <!-- Meals will be inserted here by JavaScript -->
          </tbody>
        </table>
      </div>

      <div class="summary">
        <h2>Daily Summary</h2>
        <div class="circle">
            <p>Total Calories</p>
            <p class="big-text" id="total-calories">0</p>
            <p>of {{ daily_nutrition.goal_calories }}</p>
        </div>
        <div class="macros">
            <p>
                Proteins: <span id="total-proteins">0</span>/<span id="goal-proteins">{{ daily_nutrition.goal_proteins }}</span>g
                <div class="progress-bar">
                    <div class="progress" style="width: {{ daily_nutrition.protein_percentage }}%"></div>
                </div>
            </p>
            <p>
                Fats: <span id="total-fats">0</span>/<span id="goal-fats">{{ daily_nutrition.goal_fats }}</span>g
                <div class="progress-bar">
                    <div class="progress" style="width: {{ daily_nutrition.fat_percentage }}%"></div>
                </div>
            </p>
            <p>
                Carbs: <span id="total-carbs">0</span>/<span id="goal-carbs">{{ daily_nutrition.goal_carbs }}</span>g
                <div class="progress-bar">
                    <div class="progress" style="width: {{ daily_nutrition.carb_percentage }}%"></div>
                </div>
            </p>
        </div>
        <div class="water-tracker">
            <h3>Water Intake</h3>
            <div>
                <span id="water-intake">{{ daily_nutrition.water_intake }}</span> ml
                <progress value="{{ daily_nutrition.water_intake }}" max="{{ water_goal }}"></progress>
                <button onclick="updateWaterIntake(250)">+250</button>
                <button onclick="updateWaterIntake(-250)">-250</button>
            </div>
        </div>
    </div>

    <div id="meal-modal" class="modal">
      <div class="modal-content">
        <h2>Add Meal</h2>
        <label for="meal-date">Date:</label>
        <input type="date" id="meal-date" required />

        <label for="meal-type">Meal Type:</label>
        <select id="meal-type" required>
          <option value="breakfast">Breakfast</option>
          <option value="lunch">Lunch</option>
          <option value="dinner">Dinner</option>
          <option value="snacks">Snacks</option>
        </select>

        <label for="meal-name">Meal Name:</label>
        <input
          type="text"
          id="meal-name"
          placeholder="Name of the meal"
          required
        />

        <label for="meal-calories">Calories:</label>
        <input
          type="number"
          id="meal-calories"
          placeholder="Calories"
          required
          min="0"
        />

        <label for="meal-proteins">Proteins (g):</label>
        <input
          type="number"
          id="meal-proteins"
          placeholder="Proteins"
          required
          min="0"
        />

        <label for="meal-fats">Fats (g):</label>
        <input
          type="number"
          id="meal-fats"
          placeholder="Fats"
          required
          min="0"
        />

        <label for="meal-carbs">Carbs (g):</label>
        <input
          type="number"
          id="meal-carbs"
          placeholder="Carbs"
          required
          min="0"
        />

        <button id="save-meal">Save</button>
        <button id="close-modal">Close</button>
      </div>
    </div>

    <script>
      // Helper function to get CSRF token
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // Format date as YYYY-MM-DD
      function formatDateForAPI(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // Format date for display (e.g., "Mon, Jan 1")
      function formatDisplayDate(date) {
        const options = { weekday: "short", month: "short", day: "numeric" };
        return date.toLocaleDateString("en-US", options);
      }

      // Current selected date
      let currentDate = new Date();

      // DOM elements
      const currentDateElement = document.getElementById("current-date");
      const prevDayBtn = document.getElementById("prev-day");
      const nextDayBtn = document.getElementById("next-day");
      const addMealBtn = document.getElementById("add-meal");
      const mealModal = document.getElementById("meal-modal");
      const closeModalBtn = document.getElementById("close-modal");
      const saveMealBtn = document.getElementById("save-meal");
      const mealsList = document.getElementById("meals-list");

      // Initialize the page
      function init() {
        updateDateDisplay();
        loadDailyData();

        // Set up event listeners
        prevDayBtn.addEventListener("click", () => {
          currentDate.setDate(currentDate.getDate() - 1);
          updateDateDisplay();
          loadDailyData();
        });

        nextDayBtn.addEventListener("click", () => {
          currentDate.setDate(currentDate.getDate() + 1);
          updateDateDisplay();
          loadDailyData();
        });

        addMealBtn.addEventListener("click", () => {
          document.getElementById("meal-date").valueAsDate = currentDate;
          mealModal.style.display = "flex";
        });

        closeModalBtn.addEventListener("click", () => {
          mealModal.style.display = "none";
        });

        saveMealBtn.addEventListener("click", saveMeal);

        // Set up auto-refresh every minute
        setInterval(loadDailyData, 60000);
      }

      // Update the displayed date
      function updateDateDisplay() {
        currentDateElement.textContent = formatDisplayDate(currentDate);
      }

      // Load daily data (meals, water intake, goals)
      async function loadDailyData() {
        const dateStr = formatDateForAPI(currentDate);

        try {
          // Load meals and nutrition data
          const response = await fetch(
            `/nutrition/api/get-daily-nutrition/?date=${dateStr}`
          );
          if (!response.ok) throw new Error("Failed to load daily data");
          const data = await response.json();

          if (data.status === "success") {
            updateMealsList(data.meals);
            updateWaterIntakeDisplay(data.water_intake || 0);
            updateNutritionSummary(data);
          }
        } catch (error) {
          console.error("Error loading daily data:", error);
        }
      }

      // Update meals list in UI
      function updateMealsList(meals) {
        mealsList.innerHTML = "";

        if (!meals || meals.length === 0) {
          mealsList.innerHTML =
            '<tr><td colspan="2">No meals recorded for this day</td></tr>';
          return;
        }

        // Group meals by type
        const mealsByType = {
          breakfast: [],
          lunch: [],
          dinner: [],
          snacks: [],
        };

        meals.forEach((meal) => {
          mealsByType[meal.meal_type].push(meal);
        });

        // Add meals to table
        for (const [mealType, meals] of Object.entries(mealsByType)) {
          if (meals.length === 0) continue;

          const typeRow = document.createElement("tr");
          typeRow.innerHTML = `<td colspan="2"><strong>${
            mealType.charAt(0).toUpperCase() + mealType.slice(1)
          }</strong></td>`;
          mealsList.appendChild(typeRow);

          meals.forEach((meal) => {
            const mealRow = document.createElement("tr");
            mealRow.innerHTML = `
                <td>${meal.name}</td>
                <td>
                    ${meal.calories} kcal | 
                    P: ${meal.proteins}g | 
                    F: ${meal.fats}g | 
                    C: ${meal.carbs}g
                    <button class="delete-meal" data-meal-id="${meal.id}">×</button>
                </td>
            `;
            mealsList.appendChild(mealRow);
          });
        }

        // Add event listeners to delete buttons
        document.querySelectorAll(".delete-meal").forEach((btn) => {
          btn.addEventListener("click", deleteMeal);
        });
      }

      // Update water intake display
      function updateWaterIntakeDisplay(amount) {
        document.getElementById("water-intake").textContent = amount;
      }

      // Update nutrition summary (calories and macros)
      function updateNutritionSummary(data) {
        const totalCalories = data.calories || 0;
        const totalProteins = data.proteins || 0;
        const totalFats = data.fats || 0;
        const totalCarbs = data.carbs || 0;
        const goalCalories = data.goal_calories || 0;
        const goalProteins = data.goal_proteins || 0;
        const goalFats = data.goal_fats || 0;
        const goalCarbs = data.goal_carbs || 0;

        // Update UI
        document.getElementById("total-calories").textContent = totalCalories;
        document.getElementById("total-proteins").textContent = totalProteins;
        document.getElementById("total-fats").textContent = totalFats;
        document.getElementById("total-carbs").textContent = totalCarbs;

        document.getElementById("goal-proteins").textContent = goalProteins;
        document.getElementById("goal-fats").textContent = goalFats;
        document.getElementById("goal-carbs").textContent = goalCarbs;

        const remainingCalories = goalCalories - totalCalories;
        const remainingElement = document.getElementById(
          "remaining-calories-value"
        );
        remainingElement.textContent = Math.abs(remainingCalories);

        if (remainingCalories >= 0) {
          remainingElement.className = "remaining-positive";
        } else {
          remainingElement.className = "remaining-negative";
        }
      }

      // Save a new meal
      async function saveMeal() {
        const mealData = {
          date: document.getElementById("meal-date").value,
          meal_type: document.getElementById("meal-type").value,
          name: document.getElementById("meal-name").value,
          calories:
            parseInt(document.getElementById("meal-calories").value) || 0,
          proteins:
            parseInt(document.getElementById("meal-proteins").value) || 0,
          fats: parseInt(document.getElementById("meal-fats").value) || 0,
          carbs: parseInt(document.getElementById("meal-carbs").value) || 0,
        };

        try {
          const response = await fetch("/nutrition/api/save-meal/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(mealData),
          });

          if (!response.ok) throw new Error("Failed to save meal");

          // Close modal and refresh data
          mealModal.style.display = "none";
          loadDailyData();
        } catch (error) {
          console.error("Error saving meal:", error);
          alert("Error saving meal: " + error.message);
        }
      }

      // Delete a meal
      async function deleteMeal(e) {
        const mealId = e.currentTarget.getAttribute("data-meal-id");

        if (!confirm("Are you sure you want to delete this meal?")) return;

        try {
          const response = await fetch(
            `/nutrition/api/delete-meal/${mealId}/`,
            {
              method: "DELETE",
              headers: {
                "X-CSRFToken": getCookie("csrftoken"),
              },
            }
          );

          if (!response.ok) throw new Error("Failed to delete meal");

          // Refresh data
          loadDailyData();
        } catch (error) {
          console.error("Error deleting meal:", error);
          alert("Error deleting meal: " + error.message);
        }
      }

      // Update water intake
      async function updateWaterIntake(amount) {
        const dateStr = formatDateForAPI(currentDate);
        const currentAmount =
          parseInt(document.getElementById("water-intake").textContent) || 0;
        const newAmount = Math.max(0, currentAmount + amount);

        try {
          const response = await fetch("/nutrition/api/update-water-intake/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({
              date: dateStr,
              amount: newAmount,
            }),
          });

          if (!response.ok) throw new Error("Failed to update water intake");

          // Update UI
          document.getElementById("water-intake").textContent = newAmount;
        } catch (error) {
          console.error("Error updating water intake:", error);
          alert("Error updating water intake: " + error.message);
        }
      }

      // Initialize the application when the DOM is loaded
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
