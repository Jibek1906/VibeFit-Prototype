{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'css/nutrition.css' %}" />
    <title>Calories Counter</title>
    <style>
      .header {
        height: 60px;
      }
      .today {
        background-color: #9b957e;
        color: white;
        border-radius: 50%;
        padding: 5px;
      }
      .selected-day {
        border: 2px solid #9b957e;
      }
      .meal-entry {
        background-color: #f5f5f5;
        padding: 5px;
        margin: 3px 0;
        border-radius: 3px;
      }
      .remaining-positive {
        color: green;
      }
      .remaining-negative {
        color: red;
      }
    </style>
  </head>
  <body>
    {% include 'components/header.html' %}

    <div class="container">
      <div class="calendar">
        <div class="calendar-header">
          <button id="prev-week">&lt;</button>
          <h2 id="current-week"></h2>
          <button id="next-week">&gt;</button>
          <button id="add-meal">Add Meal</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Breakfast</th>
              <th>Lunch</th>
              <th>Dinner</th>
              <th>Snacks</th>
            </tr>
          </thead>
          <tbody id="calendar-body">
            <!-- Calendar content will be generated by JavaScript -->
          </tbody>
        </table>
      </div>

      <div class="summary">
        <h2>Daily Summary</h2>
        <div class="circle">
          <p>Total Calories</p>
          <p class="big-text" id="total-calories">0</p>
          <p>kcal</p>
        </div>
        <div class="macros">
          <p>
            Proteins: <span id="total-proteins">0</span>/<span
              id="goal-proteins"
              >0</span
            >
            g
          </p>
          <p>
            Fats: <span id="total-fats">0</span>/<span id="goal-fats">0</span> g
          </p>
          <p>
            Carbs: <span id="total-carbs">0</span>/<span id="goal-carbs"
              >0</span
            >
            g
          </p>
        </div>
        <div class="remaining-calories">
          Remaining: <span id="remaining-calories-value">0</span> kcal
        </div>
        <div class="training-recommendation" id="training-recommendation"></div>
      </div>
    </div>

    <div id="meal-modal" class="modal">
      <div class="modal-content">
        <h2>Add Meal</h2>
        <label for="meal-date">Date:</label>
        <input type="date" id="meal-date" required />

        <label for="meal-type">Meal Type:</label>
        <select id="meal-type" required>
          <option value="breakfast">Breakfast</option>
          <option value="lunch">Lunch</option>
          <option value="dinner">Dinner</option>
          <option value="snacks">Snacks</option>
        </select>

        <label for="meal-name">Meal Name:</label>
        <input
          type="text"
          id="meal-name"
          placeholder="Name of the meal"
          required
        />

        <label for="meal-calories">Calories:</label>
        <input
          type="number"
          id="meal-calories"
          placeholder="Calories"
          required
          min="0"
        />

        <label for="meal-proteins">Proteins (g):</label>
        <input
          type="number"
          id="meal-proteins"
          placeholder="Proteins"
          required
          min="0"
        />

        <label for="meal-fats">Fats (g):</label>
        <input
          type="number"
          id="meal-fats"
          placeholder="Fats"
          required
          min="0"
        />

        <label for="meal-carbs">Carbs (g):</label>
        <input
          type="number"
          id="meal-carbs"
          placeholder="Carbs"
          required
          min="0"
        />

        <button id="save-meal">Save</button>
        <button id="close-modal">Close</button>
      </div>
    </div>

    <script>
      // Helper function to get CSRF token
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // Calendar functions
      function getWeekDates(date) {
        const startDate = new Date(date);
        startDate.setDate(
          date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1)
        ); // Start from Monday

        const dates = [];
        for (let i = 0; i < 7; i++) {
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + i);
          dates.push(currentDate);
        }
        return dates;
      }

      function formatDate(date) {
        const options = { day: "numeric", month: "short" };
        return date.toLocaleDateString("en-US", options);
      }

      function formatDateForAPI(date) {
        return date.toISOString().split("T")[0];
      }

      function isSameDay(date1, date2) {
        return (
          date1.getDate() === date2.getDate() &&
          date1.getMonth() === date2.getMonth() &&
          date1.getFullYear() === date2.getFullYear()
        );
      }

      // Calendar rendering
      let currentDate = new Date();

      function renderCalendar() {
        const weekDates = getWeekDates(currentDate);
        const calendarBody = document.getElementById("calendar-body");
        calendarBody.innerHTML = "";

        // Update week header
        document.getElementById("current-week").textContent = `${formatDate(
          weekDates[0]
        )} - ${formatDate(weekDates[6])}`;

        // Create table rows for each day
        weekDates.forEach((date) => {
          const row = document.createElement("tr");

          // Date cell
          const dateCell = document.createElement("td");
          dateCell.textContent = formatDate(date);
          if (isSameDay(date, new Date())) {
            dateCell.classList.add("today");
          }
          row.appendChild(dateCell);

          // Meal type cells
          ["breakfast", "lunch", "dinner", "snacks"].forEach((mealType) => {
            const cell = document.createElement("td");
            cell.dataset.date = formatDateForAPI(date);
            cell.dataset.mealType = mealType;
            row.appendChild(cell);
          });

          calendarBody.appendChild(row);
        });

        // Load meals for the current week
        loadMealsForWeek(weekDates);
      }

      async function loadMealsForWeek(weekDates) {
        const dateFrom = formatDateForAPI(weekDates[0]);
        const dateTo = formatDateForAPI(weekDates[6]);

        try {
          const response = await fetch(
            `/nutrition/api/get-meals/?date_from=${dateFrom}&date_to=${dateTo}`,
            {
              headers: {
                "X-CSRFToken": getCookie("csrftoken"),
              },
            }
          );

          if (!response.ok) {
            throw new Error("Failed to load meals");
          }

          const data = await response.json();
          populateMealsInCalendar(data.meals);
        } catch (error) {
          console.error("Error loading meals:", error);
        }
      }

      function populateMealsInCalendar(meals) {
        if (!meals) return;

        meals.forEach((meal) => {
          const cell = document.querySelector(
            `td[data-date="${meal.date}"][data-meal-type="${meal.meal_type}"]`
          );
          if (cell) {
            const mealEntry = document.createElement("div");
            mealEntry.className = "meal-entry";
            mealEntry.textContent = `${meal.name} (${meal.calories} kcal)`;
            cell.appendChild(mealEntry);
          }
        });
      }

      // Navigation
      document.getElementById("prev-week").addEventListener("click", () => {
        currentDate.setDate(currentDate.getDate() - 7);
        renderCalendar();
      });

      document.getElementById("next-week").addEventListener("click", () => {
        currentDate.setDate(currentDate.getDate() + 7);
        renderCalendar();
      });

      // Meal modal
      const modal = document.getElementById("meal-modal");
      const addMealBtn = document.getElementById("add-meal");
      const closeBtn = document.getElementById("close-modal");

      addMealBtn.addEventListener("click", () => {
        const today = new Date();
        document.getElementById("meal-date").valueAsDate = today;
        modal.style.display = "block";
      });

      closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
      });

      window.addEventListener("click", (event) => {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      });

      // Save meal
      document
        .getElementById("save-meal")
        .addEventListener("click", async () => {
          const mealData = {
            date: document.getElementById("meal-date").value,
            meal_type: document.getElementById("meal-type").value,
            name: document.getElementById("meal-name").value,
            calories:
              parseInt(document.getElementById("meal-calories").value) || 0,
            proteins:
              parseInt(document.getElementById("meal-proteins").value) || 0,
            fats: parseInt(document.getElementById("meal-fats").value) || 0,
            carbs: parseInt(document.getElementById("meal-carbs").value) || 0,
          };

          try {
            const response = await fetch("/nutrition/api/save-meal/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
              },
              body: JSON.stringify(mealData),
            });

            if (!response.ok) {
              throw new Error("Failed to save meal");
            }

            // Refresh data
            renderCalendar();
            updateNutritionSummary();
            modal.style.display = "none";
          } catch (error) {
            console.error("Error saving meal:", error);
            alert("Error saving meal: " + error.message);
          }
        });

      // Nutrition summary
      async function updateNutritionSummary() {
        try {
          // Get user goals
          const caloriesResponse = await fetch(
            "/nutrition/api/calculate-calories/",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
              },
              body: JSON.stringify({}),
            }
          );

          if (!caloriesResponse.ok) {
            throw new Error("Failed to calculate calories");
          }

          const goals = await caloriesResponse.json();

          // Get today's meals
          const today = formatDateForAPI(new Date());
          const mealsResponse = await fetch(
            `/nutrition/api/get-meals/?date_from=${today}&date_to=${today}`
          );

          if (!mealsResponse.ok) {
            throw new Error("Failed to load meals");
          }

          const mealsData = await mealsResponse.json();

          // Calculate totals
          let totalCalories = 0;
          let totalProteins = 0;
          let totalFats = 0;
          let totalCarbs = 0;

          if (mealsData.meals && mealsData.meals.length > 0) {
            mealsData.meals.forEach((meal) => {
              totalCalories += meal.calories;
              totalProteins += meal.proteins;
              totalFats += meal.fats;
              totalCarbs += meal.carbs;
            });
          }

          // Update UI
          document.getElementById("total-calories").textContent = totalCalories;
          document.getElementById("total-proteins").textContent = totalProteins;
          document.getElementById("total-fats").textContent = totalFats;
          document.getElementById("total-carbs").textContent = totalCarbs;

          document.getElementById("goal-proteins").textContent = goals.proteins;
          document.getElementById("goal-fats").textContent = goals.fats;
          document.getElementById("goal-carbs").textContent = goals.carbs;

          const remainingCalories = goals.calories - totalCalories;
          const remainingElement = document.getElementById(
            "remaining-calories-value"
          );
          remainingElement.textContent = remainingCalories;

          if (remainingCalories >= 0) {
            remainingElement.className = "remaining-positive";
          } else {
            remainingElement.className = "remaining-negative";
          }
        } catch (error) {
          console.error("Error updating nutrition summary:", error);
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        renderCalendar();
        updateNutritionSummary();

        // Update summary every minute
        setInterval(updateNutritionSummary, 60000);
      });
    </script>
  </body>
</html>
